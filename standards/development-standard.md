# 游戏功能开发规范 V2.0

## 1. 目的与原则

**目标**：本规范旨在定义一个清晰、高效、高质量的开发流程。所有功能开发都必须严格遵循本规范，确保最终交付的代码满足**可维护性、可测试性与高性能**的要求。

**核心原则**：
- **设计先行**：编码前必须完成清晰的类级详细设计。
- **测试驱动**：优先编写测试用例，以测试验证和驱动功能实现。
- **持续验证**：通过自动化工具和代码审查，在开发早期发现并修复问题。
- **文档同步**：代码实现必须与设计文档保持一致。

## 2. 核心开发流程

```mermaid
graph TD
    A[1. 需求分析与任务拆解] --> B{2. 类级详细设计};
    B --> C[3. 编写单元测试];
    C --> D[4. 实现功能代码];
    D --> E{5. 静态检查};
    E -- 修复 --> D;
    E -- 通过 --> F[6. 运行单元测试];
    F -- 修复 --> D;
    F -- 通过 --> G{7. 代码审查 (Code Review)};
    G -- 修改 --> D;
    G -- 通过 --> H[8. 功能验收];

    subgraph "阶段一：设计"
        A
        B
    end

    subgraph "阶段二：实现与测试"
        C
        D
        E
        F
    end

    subgraph "阶段三：审查与验收"
        G
        H
    end
```

---

### 步骤 1：需求分析与任务拆解
- **行动**：
    1.  仔细阅读策划案和技术文档，确保完全理解功能需求。
    2.  将开发任务与策划案、技术文档的具体条目进行编号映射。
- **交付物**：
    - 任务清单（Trello, Jira, etc.），包含文档编号映射。
    - 符合项目规范的 Git 开发分支。

### 步骤 2：类级详细设计
- **行动**：
    1.  在正式编码前，为每一个待开发的模块或类，参照下方模板完成**类级详细设计文档**。
    2.  设计文档需经过团队评审并通过后，方可进入下一步。
- **交付物**：
    - 每个类的详细设计文档（.md格式）。

### 步骤 3：编写单元测试
- **行动**：
    1.  根据详细设计，为每个公开方法编写单元测试。
    2.  测试用例必须覆盖**正向、边界、异常**三种场景。
    3.  测试脚本命名规范：`[ClassName]Tests.cs`。
    4.  测试方法命名规范：`MethodName_Should_ExpectedBehavior_When_Condition`。
    5.  测试脚本存放于 `Assets/Tests/Editor` 或 `Assets/Tests/PlayMode` 目录。
- **交付物**：
    - 可在 Test Runner 中运行的测试代码。

### 步骤 4：实现功能代码
- **行动**：
    1.  严格依据已评审的详细设计文档进行编码。
    2.  遵循项目编码规范（命名、目录结构、依赖关系等）。
    3.  **最小化实现**：编写刚好能让测试通过的代码，然后进行重构优化。
- **交付物**：
    - 功能代码，实现与测试用例一一对应。

### 步骤 5：静态检查
- **行动**：
    1.  使用 `unity-mcp` 工具对代码进行静态检查和编译诊断。
    2.  **零错误原则**：必须修复所有报告的错误，直至检查结果为零错误。
- **交付物**：
    - `unity-mcp` 编译通过的数据。

### 步骤 6：运行单元测试
- **行动**：
    1.  在 Unity Test Runner 中运行所有相关测试。
    2.  **全通过原则**：必须修复所有失败的测试用例，直至全部通过。
- **交付物**：
    - Test Runner 测试全通过数据。

### 步骤 7：代码审查 (Code Review)
- **行动**：
    1.  当所有测试通过后，提交 Pull Request (PR) 进行代码审查。
    2.  审查人 (Reviewer) 依据设计文档、编码规范和最佳实践进行审查。
    3.  开发者根据审查意见修改代码，直至 PR 被批准。
- **交付物**：
    - 已批准并合并的 Pull Request 链接。

### 步骤 8：功能验收
- 功能开发完成，代码合入主干分支。

---

## 3. 验收标准 (Definition of Done)

- **[✓] 设计文档**：所有模块和类均有完整、清晰的类级详细设计文档。
- **[✓] 测试覆盖**：核心逻辑的单元测试覆盖率达到标准，测试用例覆盖正向、边界和异常场景。
- **[✓] 代码质量**：通过 `unity-mcp` 静态检查，无任何错误或严重警告。
- **[✓] 功能正确**：所有相关单元测试在 Test Runner 中全部通过。
- **[✓] 文档同步**：最终代码实现与设计文档完全一致。
- **[✓] 流程合规**：开发过程完整遵循本文档定义的流程，提交记录清晰，并经过代码审查。

---

## 4. 附录：模板

### 4.1 类级详细设计模板

- **基本信息**
    - **类名**: `PlayerController`
    - **命名空间**: `Daybreak.Gameplay.Player`
    - **所在程序集**: `Daybreak.Gameplay`
    - **职责描述**: 负责接收玩家输入并控制角色移动与行为。
- **依赖关系**
    - **模块/接口**: `IInputService`, `CharacterAnimation`
    - **资源**: `PlayerPrefab`, `MovementSound`
- **字段列表**

| 字段名 | 类型 | 访问修饰符 | 默认值 | 职责说明 | 线程安全 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `_moveSpeed` | `float` | `private` | `5.0f` | 角色的移动速度 | 否 |
| `_isGrounded`| `bool` | `private` | `true` | 角色是否在地面 | 否 |

- **方法列表**

| 方法签名 | 返回值 | 职责说明 |
| :--- | :--- | :--- |
| `Move(Vector2 direction)` | `void` | 根据输入方向移动角色。 |
| `Jump()` | `void` | 执行跳跃动作。 |
| `IsGrounded()`| `bool`| 检查角色当前是否接触地面。 |

- **备注**
    - 性能：`Move()` 方法将在 `Update()` 中高频调用，需避免GC。
    - 反射：无。

